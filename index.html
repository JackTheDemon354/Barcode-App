<!DOCTYPE html>
<html>
<head>
  <title>Barcode Scanner List</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    video { width: 300px; border: 1px solid #333; }
    .item { margin: 1em 0; }
  </style>
</head>
<body>
  <h1>ðŸ“· Scan a Barcode</h1>
  <video id="scanner" autoplay></video>
  <div id="list"></div>

  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <script>
    const list = document.getElementById('list');
    const API = 'https://YOUR-RENDER-APP.onrender.com'; // CHANGE THIS!

    const addItemToList = (item) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<strong>${item.name}</strong> - $${item.price}<br><small>${item.barcode}</small>`;
      list.appendChild(div);
    };

    const promptAndSaveItem = async (barcode) => {
      const name = prompt(`New item\nBarcode: ${barcode}\nEnter name:`);
      if (!name) return;
      const price = prompt(`Enter price for ${name}:`);
      if (!price) return;
      const res = await fetch(`${API}/product`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcode, name, price })
      });
      const data = await res.json();
      addItemToList(data);
    };

    const handleScan = async (code) => {
      try {
        const res = await fetch(`${API}/product/${code}`);
        if (res.status === 404) {
          await promptAndSaveItem(code);
        } else {
          const data = await res.json();
          addItemToList(data);
        }
      } catch (err) {
        console.error('Error:', err);
      }
    };

    let lastCode = '';
    let lastTime = 0;

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector('#scanner'),
        constraints: { facingMode: "environment" }
      },
      decoder: { readers: ["ean_reader", "code_128_reader"] }
    }, err => {
      if (err) return console.error(err);
      Quagga.start();
    });

    Quagga.onDetected(data => {
      const code = data.codeResult.code;
      const now = Date.now();
      if (code !== lastCode || now - lastTime > 3000) {
        lastCode = code;
        lastTime = now;
        handleScan(code);
      }
    });
  </script>
</body>
</html>
