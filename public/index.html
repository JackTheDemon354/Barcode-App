<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi Barcode Upload + Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

    const SUPABASE_URL = 'https://wiklfzmcvmevdwpoofuc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // use full key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const codeReader = new BrowserMultiFormatReader();

    async function scanAndSave(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async () => {
          const img = new Image();
          img.src = reader.result;

          img.onload = async () => {
            try {
              const result = await codeReader.decodeFromImage(img);
              const barcode = result.text;
              const name = prompt(`Scanned: ${barcode}\nEnter product name:`);
              if (!name) return resolve();

              const price = prompt(`Product: ${name}\nEnter price:`);
              if (!price) return resolve();

              const { error } = await supabase
                .from('products')
                .insert([{ barcode, name, price }]);

              if (error) alert("‚ùå Error saving: " + error.message);
              else alert("‚úÖ Saved: " + barcode);

              resolve();
            } catch (err) {
              alert("‚ùå Couldn't scan this image: " + err.message);
              resolve();
            }
          };
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById("upload").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files);
      for (const file of files) {
        await scanAndSave(file);
      }
    });

    document.getElementById("start-camera-scan").addEventListener("click", async () => {
      const video = document.getElementById("video-preview");
      video.style.display = "block";

      try {
        const result = await codeReader.decodeOnceFromVideoDevice(undefined, video);
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = "none";

        const barcode = result.text;
        const name = prompt(`Scanned: ${barcode}\nEnter product name:`);
        if (!name) return;
        const price = prompt(`Product: ${name}\nEnter price:`);
        if (!price) return;

        const { error } = await supabase
          .from('products')
          .insert([{ barcode, name, price }]);

        if (error) alert("‚ùå Error saving: " + error.message);
        else alert("‚úÖ Saved: " + barcode);

      } catch (err) {
        alert("Camera scan failed: " + err.message);
      }
    });
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; }
    video { width: 100%; display: none; border: 2px solid #000; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üì¶ Upload or Scan Barcodes</h1>
  <button id="start-camera-scan">üì∏ Scan from Camera</button>
  <video id="video-preview"></video>
  <input type="file" id="upload" accept="image/*" multiple />
</body>
</html>
