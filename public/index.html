<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload & Scan Barcodes</title>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

    const SUPABASE_URL = 'https://wiklfzmcvmevdwpoofuc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indpa2xmem1jdm1ldmR3cG9vZnVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NTk5NTAsImV4cCI6MjA2ODIzNTk1MH0.ph15o1doNO3fE6VSuvRblmwNaC8py9ap6zRfZobAnQQ';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const codeReader = new BrowserMultiFormatReader();

  async function scanImageFile(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();

    reader.onload = async () => {
      const img = new Image();
      img.src = reader.result;

      img.onload = async () => {
        try {
          // Use decodeFromImageElement here
          const result = await codeReader.decodeFromImageElement(img);
          console.log("Scanned:", result.text);

          const barcode = result.text;
          const name = prompt(`Scanned: ${barcode}\n\nEnter product name:`);
          if (!name) return resolve();

          const price = prompt(`Product: ${name}\n\nEnter product price:`);
          if (!price) return resolve();

          const { error } = await supabase
            .from('products')
            .insert([{ barcode, name, price }]);

          if (error) {
            alert("‚ùå Error saving: " + error.message);
          } else {
            alert("‚úÖ Saved: " + barcode);
          }

          resolve();
        } catch (err) {
          console.error("Scan failed:", err);
          alert("‚ùå Could not scan this image.");
          resolve();
        }
      };

      img.onerror = () => {
        alert("‚ùå Could not load image.");
        resolve();
      };
    };

    reader.readAsDataURL(file);
  });
}

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById("upload").addEventListener("change", async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        for (const file of files) {
          await scanImageFile(file);
        }
      });

      document.getElementById("start-camera-scan").addEventListener("click", async () => {
        const video = document.getElementById("video-preview");
        video.style.display = "block";

        try {
          const result = await codeReader.decodeOnceFromVideoDevice(undefined, video);
          const barcode = result.text;

          video.srcObject.getTracks().forEach(track => track.stop());
          video.style.display = "none";

          const name = prompt(`Scanned: ${barcode}\nEnter product name:`);
          if (!name) return;

          const price = prompt(`Product: ${name}\nEnter price:`);
          if (!price) return;

          const { error } = await supabase
            .from('products')
            .insert([{ barcode, name, price }]);

          if (error) {
            alert("‚ùå Error saving: " + error.message);
          } else {
            alert("‚úÖ Saved: " + barcode);
          }

        } catch (err) {
          alert("‚ùå Camera scan failed: " + err.message);
        }
      });
    });
  </script>

  <style>
    body { font-family: Calibri, Comic Sans MS; padding: 20px; max-width: 600px; margin: auto; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
    #video-preview { width: 100%; max-height: 300px; display: none; border: 2px solid black; }
  </style>
</head>
<body>
  <h1>üì∑ Upload or Scan Barcodes</h1>

  <button id="start-camera-scan">üì∏ Scan with Camera</button>
  <video id="video-preview"></video>

  <h2>üñºÔ∏è Upload Barcode Images</h2>
  <input type="file" id="upload" accept="image/*" multiple />
</body>
</html>
