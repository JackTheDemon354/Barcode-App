<!DOCTYPE html>
<html>
<head>
  <title>Barcode Scanner List</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    video { width: 300px; border: 1px solid #333; }
    .item { margin: 1em 0; }
    .item button {
      margin-left: 1em;
      padding: 0.2em 0.5em;
      cursor: pointer;
    }
    #manual-barcode {
      margin: 1em 0;
    }
  </style>
</head>
<body>
  <h1>ðŸ“· Scan a Barcode</h1>

  <video id="scanner" autoplay></video>
  <br />

  <label for="upload">Or upload images (PNG, JPG, JPEG, SVG):</label>
  <input type="file" id="upload" accept=".png,.jpg,.jpeg,.svg" multiple />

  <div id="manual-barcode">
    <h3>Or enter barcode number manually:</h3>
    <input type="text" id="barcode-input" placeholder="Enter barcode number" />
    <button id="add-barcode-btn">Add Item</button>
  </div>

  <h2>Shopping List</h2>
  <div id="list"></div>

  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <script>
    const list = document.getElementById('list');
    const API = 'https://barcode-app-rpjp.onrender.com'; // Put your backend URL here!

    const displayedBarcodes = new Set();

    const addItemToList = (item) => {
      if (displayedBarcodes.has(item.barcode)) return;

      displayedBarcodes.add(item.barcode);

      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.barcode = item.barcode;
      div.innerHTML = `
        <strong>${item.name}</strong> - $${item.price} <br>
        <small>${item.barcode}</small>
        <button>Delete</button>
      `;

      div.querySelector('button').addEventListener('click', async () => {
        const res = await fetch(`${API}/product/${item.barcode}`, { method: 'DELETE' });
        if (res.ok) {
          displayedBarcodes.delete(item.barcode);
          div.remove();
        } else {
          alert('Failed to delete item');
        }
      });

      list.appendChild(div);
    };

    const promptAndSaveItem = async (barcode) => {
      const name = prompt(`New item\nBarcode: ${barcode}\nEnter name:`);
      if (!name) return;
      const price = prompt(`Enter price for ${name}:`);
      if (!price) return;
      const res = await fetch(`${API}/product`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcode, name, price })
      });
      const data = await res.json();
      addItemToList(data);
    };

    const handleScan = async (code) => {
      if (displayedBarcodes.has(code)) return;

      try {
        const res = await fetch(`${API}/product/${code}`);
        if (res.status === 404) {
          await promptAndSaveItem(code);
        } else {
          const data = await res.json();
          addItemToList(data);
        }
      } catch (err) {
        console.error('Error:', err);
      }
    };

    // Camera live scan cooldown
    let lastCode = '';
    let lastTime = 0;

   Quagga.init({
  inputStream: {
    type: "LiveStream",
    target: document.querySelector('#scanner'),
    constraints: { facingMode: "environment" }
  },
  decoder: {
    readers: [
      "code_128_reader",
      "ean_reader",
      "ean_8_reader",
      "code_39_reader",
      "code_39_vin_reader",
      "codabar_reader",
      "upc_reader",
      "upc_e_reader",
      "i2of5_reader",
      "2of5_reader",
      "code_93_reader"
    ]
  }
}, err => {
  if (err) return console.error(err);
  Quagga.start();
});

    Quagga.onDetected(data => {
      const code = data.codeResult.code;
      const now = Date.now();
      if (code !== lastCode || now - lastTime > 3000) {
        lastCode = code;
        lastTime = now;
        handleScan(code);
      }
    });

    // Multiple file upload scanning
    document.getElementById('upload').addEventListener('change', function() {
      const files = this.files;
      if (!files.length) return;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();

        reader.onload = function(e) {
          Quagga.decodeSingle({
            src: e.target.result,
            numOfWorkers: 0,
            inputStream: { size: 800 },
            decoder: {
              readers: ["code_128_reader", "ean_reader", "ean_8_reader"]
            }
          }, function(result) {
            if(result && result.codeResult) {
              handleScan(result.codeResult.code);
            } else {
              alert('Barcode not detected in image: ' + file.name);
            }
          });
        };

        reader.readAsDataURL(file);
      }

      this.value = ''; // reset input so same files can be uploaded again
    });

    // Manual barcode input
    document.getElementById('add-barcode-btn').addEventListener('click', () => {
      const input = document.getElementById('barcode-input');
      const code = input.value.trim();
      if (!code) {
        alert('Please enter a barcode number.');
        return;
      }
      input.value = '';
      handleScan(code);
    });

  </script>
</body>
</html>
