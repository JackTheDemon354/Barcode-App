<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Shopping</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    const SUPABASE_URL = 'https://wiklfzmcvmevdwpoofuc.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const codeReader = new BrowserMultiFormatReader();

    let cart = [];

    function updateCartDisplay() {
      const cartEl = document.getElementById('cart');
      cartEl.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const itemTotal = parseFloat(item.price) * item.quantity;
        total += itemTotal;
        const div = document.createElement('div');
        div.textContent = `${item.name} (x${item.quantity}) - $${itemTotal.toFixed(2)}`;
        cartEl.appendChild(div);
      });

      document.getElementById('total').textContent = `Total: $${total.toFixed(2)}`;
    }

    async function scanImageFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();

        reader.onload = async () => {
          const img = new Image();
          img.src = reader.result;

          img.onload = async () => {
            try {
              const result = await codeReader.decodeOnceFromImageElement(img);
              const barcode = result.text;

              // Lookup product in Supabase by barcode
              const { data: products, error } = await supabase
                .from('products')
                .select()
                .eq('barcode', barcode)
                .limit(1);

              if (error || !products || products.length === 0) {
                alert('Product not found in database.');
                resolve();
                return;
              }

              const product = products[0];
              const cartItem = cart.find((c) => c.barcode === product.barcode);
              if (cartItem) {
                cartItem.quantity++;
              } else {
                cart.push({ ...product, quantity: 1 });
              }
              updateCartDisplay();
              alert(`Added to cart: ${product.name}`);

              resolve();
            } catch (err) {
              alert("Could not scan this image.");
              resolve();
            }
          };
          img.onerror = () => {
            alert("Could not load image.");
            resolve();
          };
        };

        reader.readAsDataURL(file);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('upload').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
          await scanImageFile(file);
        }
      });

      document.getElementById('start-camera-scan').addEventListener('click', async () => {
        const video = document.getElementById('video-preview');
        video.style.display = 'block';

        try {
          const result = await codeReader.decodeOnceFromVideoDevice(undefined, video);
          const barcode = result.text;

          video.srcObject.getTracks().forEach(track => track.stop());
          video.style.display = 'none';

          // Lookup product as above
          const { data: products, error } = await supabase
            .from('products')
            .select()
            .eq('barcode', barcode)
            .limit(1);

          if (error || !products || products.length === 0) {
            alert('Product not found in database.');
            return;
          }

          const product = products[0];
          const cartItem = cart.find((c) => c.barcode === product.barcode);
          if (cartItem) {
            cartItem.quantity++;
          } else {
            cart.push({ ...product, quantity: 1 });
          }
          updateCartDisplay();
          alert(`Added to cart: ${product.name}`);

        } catch (err) {
          alert('Camera scan failed: ' + err.message);
        }
      });
    });
  </script>

  <style>
    body { font-family: Calibri, Comic Sans MS; max-width: 600px; margin: auto; padding: 20px; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
    #video-preview { width: 100%; max-height: 300px; display: none; border: 2px solid black; }
    #cart > div { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Customer Shopping</h1>

  <button id="start-camera-scan">ðŸ“¸ Scan with Camera</button>
  <video id="video-preview"></video>

  <h2>Upload Barcode Images</h2>
  <input type="file" id="upload" accept="image/*" multiple />

  <h2>Shopping Cart</h2>
  <div id="cart"></div>
  <div id="total">Total: $0.00</div>
</body>
</html>
