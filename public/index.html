<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Self-Checkout</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    const SUPABASE_URL = 'https://wiklfzmcvmevdwpoofuc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indpa2xmem1jdm1ldmR3cG9vZnVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NTk5NTAsImV4cCI6MjA2ODIzNTk1MH0.ph15o1doNO3fE6VSuvRblmwNaC8py9ap6zRfZobAnQQ';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const codeReader = new BrowserMultiFormatReader();

    let cart = {};

    function formatPrice(price) {
      return `$${parseFloat(price).toFixed(2)}`;
    }

    function updateCartUI() {
      const cartTable = document.getElementById('cart-table-body');
      cartTable.innerHTML = '';
      let total = 0;

      for (const barcode in cart) {
        const item = cart[barcode];
        total += parseFloat(item.price) * item.qty;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td>${formatPrice(item.price)}</td>
          <td><input type="number" min="1" value="${item.qty}" data-barcode="${barcode}" class="qty-input" style="width:60px;"></td>
          <td>${formatPrice(item.price * item.qty)}</td>
          <td><button class="remove-btn" data-barcode="${barcode}">‚ùå</button></td>
        `;
        cartTable.appendChild(tr);
      }

      document.getElementById('cart-total').textContent = formatPrice(total);

      document.querySelectorAll('.qty-input').forEach(input => {
        input.onchange = e => {
          const b = e.target.dataset.barcode;
          let val = parseInt(e.target.value);
          if (isNaN(val) || val < 1) val = 1;
          cart[b].qty = val;
          updateCartUI();
        };
      });

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.onclick = e => {
          const b = e.target.dataset.barcode;
          delete cart[b];
          updateCartUI();
        };
      });
    }

    async function lookupProduct(barcode) {
      let { data, error } = await supabase
        .from('products')
        .select('*')
        .eq('barcode', barcode)
        .limit(1)
        .single();

      if (error || !data) {
        return null;
      }
      return data;
    }

    async function searchProducts(query) {
      if (!query) return [];
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .or(`barcode.ilike.%${query}%,name.ilike.%${query}%`)
        .limit(10);

      if (error) {
        console.error('Search error:', error);
        return [];
      }
      return data;
    }

    async function addToCart(barcode) {
      if (cart[barcode]) {
        cart[barcode].qty++;
        updateCartUI();
        return;
      }

      const product = await lookupProduct(barcode);
      if (!product) {
        alert(`‚ùå Product not found for barcode: ${barcode}`);
        return;
      }

      cart[barcode] = {
        barcode: product.barcode,
        name: product.name,
        price: product.price,
        qty: 1,
      };
      updateCartUI();
    }

    async function scanImageFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();

        reader.onload = () => {
          const img = new Image();
          img.src = reader.result;

          img.onload = async () => {
            try {
              const result = await codeReader.decodeFromImageElement(img);
              await addToCart(result.text);
              resolve();
            } catch {
              alert("‚ùå Could not scan this image.");
              resolve();
            }
          };

          img.onerror = () => {
            alert("‚ùå Could not load image.");
            resolve();
          };
        };

        reader.readAsDataURL(file);
      });
    }

    // Modal functions
    function openSearchModal() {
      document.getElementById('search-modal').style.display = 'block';
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('search-input').focus();
    }

    function closeSearchModal() {
      document.getElementById('search-modal').style.display = 'none';
    }

    window.addEventListener('DOMContentLoaded', () => {
      // Upload barcode images
      document.getElementById('upload').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
          await scanImageFile(file);
        }
        e.target.value = '';
      });

      // Camera scan
      const video = document.getElementById('video-preview');
      document.getElementById('start-camera-scan').addEventListener('click', async () => {
        video.style.display = 'block';
        try {
          const result = await codeReader.decodeOnceFromVideoDevice(undefined, video);
          await addToCart(result.text);
        } catch (err) {
          alert("‚ùå Camera scan failed: " + err.message);
        } finally {
          if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
          }
          video.style.display = 'none';
        }
      });

      // Q search button opens modal
      document.getElementById('q-search-btn').addEventListener('click', openSearchModal);

      // Close modal button
      document.getElementById('search-close-btn').addEventListener('click', closeSearchModal);

      // Search input handler (debounced)
      let searchTimeout;
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          const query = searchInput.value.trim();
          const results = await searchProducts(query);

          const resultsContainer = document.getElementById('search-results');
          resultsContainer.innerHTML = '';

          if (results.length === 0) {
            resultsContainer.textContent = 'No products found.';
            return;
          }

          results.forEach(prod => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.textContent = `${prod.name} (Barcode: ${prod.barcode}) - $${parseFloat(prod.price).toFixed(2)}`;

            div.onclick = async () => {
              await addToCart(prod.barcode);
              closeSearchModal();
            };

            resultsContainer.appendChild(div);
          });
        }, 300);
      });

      updateCartUI();
    });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    button, input[type="file"] {
      font-size: 18px;
      padding: 12px;
      width: 100%;
      margin-bottom: 15px;
      cursor: pointer;
    }
    #video-preview {
      width: 100%;
      max-height: 300px;
      border: 2px solid black;
      display: none;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    input.qty-input {
      text-align: center;
      font-size: 16px;
      padding: 4px;
    }
    button.remove-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: red;
    }
    #total-container {
      text-align: right;
      margin-top: 10px;
      font-weight: bold;
      font-size: 18px;
    }

    /* Modal styles */
    #search-modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #search-modal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
    #search-modal h3 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }
    #search-input {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    #search-results {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 16px;
    }
    .search-result-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .search-result-item:hover {
      background-color: #f0f0f0;
    }
    #search-close-btn {
      display: block;
      margin: 15px auto 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #cc3333;
      color: white;
      border: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Coles-style Checkout</h1>

  <button id="start-camera-scan">üì∏ Scan with Camera</button>
  <button id="q-search-btn">Q Search</button>

  <video id="video-preview" autoplay muted></video>

  <h2>Upload Barcode Images</h2>
  <input type="file" id="upload" accept="image/*" multiple />

  <h2>Shopping Cart</h2>
  <table>
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Name</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Subtotal</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="cart-table-body"></tbody>
  </table>
  <div id="total-container">Total: <span id="cart-total">$0.00</span></div>

  <!-- Search Modal -->
  <div id="search-modal" role="dialog" aria-modal="true" aria-labelledby="search-modal-title">
    <div class="modal-content">
      <h3 id="search-modal-title">Search Product by Name or Barcode</h3>
      <input id="search-input" type="text" placeholder="Type product name or barcode..." autocomplete="off" />
      <div id="search-results"></div>
      <button id="search-close-btn" aria-label="Close search modal">Close</button>
    </div>
  </div>
</body>
</html>
